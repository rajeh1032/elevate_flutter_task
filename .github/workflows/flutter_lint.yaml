name: Flutter Lint Check

on:
  pull_request:
    branches:
      - "**"

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # Setup Flutter (FVM or latest stable)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Run analysis (warnings allowed)
      - name: Run Flutter Analyze
        id: analyze
        continue-on-error: true
        run: |
          flutter analyze || echo "analyze_warnings=true" >> $GITHUB_OUTPUT

      # Auto-fix formatting
      - name: Auto fix formatting
        run: dart format .

      # Check if formatting changed files
      - name: Check formatting changes
        id: format_check
        run: |
          if git diff --quiet; then
            echo "No formatting changes needed"
            echo "format_needed=false" >> $GITHUB_OUTPUT
          else
            echo "Formatting changes were applied"
            echo "format_needed=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --name-only
          fi

      # Summary
      - name: Summary
        if: always()
        run: |
          echo "## Flutter Lint Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter Version: $(flutter --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.analyze.outcome }}" == "failure" ]; then
            echo "- Analysis: Found issues (review recommended)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.format_check.outputs.format_needed }}" == "true" ]; then
            echo "- Formatting: Auto-applied (commit these changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Formatting: Already correct" >> $GITHUB_STEP_SUMMARY
          fi